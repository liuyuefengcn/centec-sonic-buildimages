From 9d57e2e1c1dfd7a8fb5c83e23bcc139047d5c428 Mon Sep 17 00:00:00 2001
From: AlanYoush <yoush@centec.com>
Date: Tue, 30 May 2023 08:19:58 +0000
Subject: [PATCH] Generate initramfs for installed kernels in chroot

---
 debian/kdump-tools.postinst | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/debian/kdump-tools.postinst b/debian/kdump-tools.postinst
index 4fd51e7..dc3e87d 100755
--- a/debian/kdump-tools.postinst
+++ b/debian/kdump-tools.postinst
@@ -70,7 +70,16 @@ case "$1" in
 	sync /etc/default/kdump-tools
 
         # create smaller initrd.img files for kdump use
-	/etc/kernel/postinst.d/kdump-tools $(uname -r) > /dev/null 2>&1
+	# /etc/kernel/postinst.d/kdump-tools $(uname -r) > /dev/null 2>&1
+       if test -d /lib/modules/$(uname -r); then
+              /etc/kernel/postinst.d/kdump-tools $(uname -r) > /dev/null 2>&1
+       else
+              # Running kernel not installed. Running in chroot?
+              for kernel_release in $(ls /lib/modules/); do
+                      /etc/kernel/postinst.d/kdump-tools $kernel_release > /dev/null 2>&1
+                      kdump-config symlinks $kernel_release
+              done
+       fi
     ;;
 
     abort-upgrade|abort-remove|abort-deconfigure)
-- 
2.25.1

